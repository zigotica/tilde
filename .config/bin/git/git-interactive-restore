#!/usr/bin/env bash

# git interactive restore wrapper to be used with fzf
# use case: giR
# use case: giR .
# shift+tab to multi pick, tab to move

if [[ $# -eq 0 ]]; then
  prev="git diff --minimal --color {}"
  win="50%,border-double,right"

  # (subshell) for temporary staging
  # otherwise untracked files are added even after escaping
  (
    # ensure cleanup even if fzf or script exits unexpectedly
    trap 'git reset >/dev/null 2>&1' EXIT

    # stage untracked files as "intent-to-add" so git diff can preview them
    git add --intent-to-add . >/dev/null 2>&1

    # list modified + untracked files (ignoring .gitignore)
    git ls-files -m -o --exclude-standard |
      fzf-tmux --print0 -m --preview="$prev" --preview-window="$win" |
      xargs -0 -t -o -r git restore --source=HEAD -- 2>/dev/null
  )

  # final safety reset (clean any “intent-to-add” leftovers)
  git reset >/dev/null 2>&1
else
  git restore --source=HEAD -- "$1"
fi

